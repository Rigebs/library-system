<form [formGroup]="bookForm" (ngSubmit)="onSubmit()">
    <div class=" form-group">
        <label for="title">Título</label>
        <input type="text" id="title" formControlName="title" placeholder="El Señor de los Anillos" />
        @if (hasError('title', 'required')) {
        <p class="error-message">El título es obligatorio.</p>
        }
    </div>

    <div class="form-group">
        <label for="author">Autor</label>
        <input type="text" id="author" formControlName="author" placeholder="J.R.R. Tolkien" />
        @if (hasError('author', 'required')) {
        <p class="error-message">El autor es obligatorio.</p>
        }
    </div>

    <div class="form-group">
        <label for="isbn">ISBN</label>
        <input type="text" id="isbn" formControlName="isbn" placeholder="978-0618260211" />
        @if (hasError('isbn', 'required')) {
        <p class="error-message">El ISBN es obligatorio.</p>
        }
    </div>

    <div class="form-group">
        <label for="publisher">Editorial</label>
        <input type="text" id="publisher" formControlName="publisher" placeholder="Houghton Mifflin" />
        @if (hasError('publisher', 'required')) {
        <p class="error-message">La editorial es obligatoria.</p>
        }
    </div>

    <div class="form-group">
        <label for="summary">Resumen</label>
        <textarea id="summary" formControlName="summary" placeholder="Un gran resumen del libro..." rows="4"></textarea>
        @if (hasError('summary', 'required')) {
        <p class="error-message">El resumen es obligatorio.</p>
        }
    </div>

    <div class="form-group">
        <label for="totalQuantity">Cantidad Total</label>
        <input type="number" id="totalQuantity" formControlName="totalQuantity" placeholder="1" />
        @if (hasError('totalQuantity', 'required')) {
        <p class="error-message">La cantidad total es obligatoria.</p>
        } @else if (hasError('totalQuantity', 'min')) {
        <p class="error-message">La cantidad debe ser al menos 1.</p>
        }
    </div>

    <div class="form-group">
        <label>Archivo Digital</label>

        <div class="upload-card" [class.uploading]="isFileUploading()" [class.success]="bookForm.get('fileUrl')?.value">
            <input type="file" accept=".pdf,.epub,application/pdf,application/epub+zip"
                (change)="onFileUpload($event, 'file')" [disabled]="isFileUploading()" />

            <!-- Estado: Idle -->
            @if (!isFileUploading() && !bookForm.get('fileUrl')?.value) {
            <div class="upload-placeholder">
                <span class="title">Subir archivo PDF o EPUB</span>
                <span class="subtitle">Haz clic para seleccionar el archivo</span>
            </div>
            }

            <!-- Estado: Uploading -->
            @if (isFileUploading()) {
            <div class="upload-status">
                <div class="spinner"></div>
                <span>Subiendo archivo...</span>
            </div>
            }

            @if (bookForm.get('fileUrl')?.value && !isFileUploading()) {
            <div class="upload-success file-success">
                <img src="/icons/file.svg" alt="Archivo" class="file-icon" />

                <div class="file-info">
                    <span class="file-name">
                        {{ uploadedFileName() }}
                    </span>
                    @if (!isEditMode()) {

                    <span class="file-status">Archivo cargado correctamente</span>
                    }
                </div>
            </div>
            }
        </div>

        <input type="hidden" formControlName="fileUrl" />

        @if (hasError('fileUrl', 'required')) {
        <p class="error-message">Debe cargar el archivo digital.</p>
        }
    </div>

    <div class="form-group">
        <label>Portada del Libro</label>

        <div class="upload-card image-card" [class.uploading]="isCoverUploading()"
            [class.success]="bookForm.get('coverUrl')?.value">
            <input type="file" accept="image/jpeg,image/png" (change)="onFileUpload($event, 'cover')"
                [disabled]="isCoverUploading()" />

            <!-- Preview -->
            @if (bookForm.get('coverUrl')?.value && !isCoverUploading()) {
            <img class="image-preview" [src]="bookForm.get('coverUrl')?.value" alt="Vista previa de portada" />
            }

            <!-- Uploading -->
            @if (isCoverUploading()) {
            <div class="upload-status">
                <div class="spinner"></div>
                <span>Subiendo portada...</span>
            </div>
            }

            <!-- Placeholder -->
            @if (!bookForm.get('coverUrl')?.value && !isCoverUploading()) {
            <div class="upload-placeholder">
                <span class="title">Subir imagen de portada</span>
                <span class="subtitle">JPG o PNG</span>
            </div>
            }
        </div>

        <input type="hidden" formControlName="coverUrl" />

        @if (hasError('coverUrl', 'required')) {
        <p class="error-message">Debe cargar la portada.</p>
        }
    </div>

    <div class="form-group">
        <label for="categoryId">Categoría</label>

        @if (categories().length === 0) {
        <p class="error-message">No hay categorías disponibles. Por favor, registre categorías primero.</p>
        } @else {
        <div class="select-wrapper"> <select id="categoryId" formControlName="categoryId">
                <option [ngValue]="null" disabled>-- Seleccione una categoría --</option>

                @for (category of categories(); track category.id) {
                <option [ngValue]="category.id">{{ category.name }}</option>
                }
            </select>
        </div> }

        @if (hasError('categoryId', 'required')) {
        <p class="error-message">La categoría es obligatoria.</p>
        } @else if (hasError('categoryId', 'min')) {
        <p class="error-message">Seleccione una categoría válida.</p>
        }

    </div>

    <button type="submit" [disabled]="bookForm.invalid || isSubmitting()">
        {{ isEditMode() ? 'Guardar Cambios' : 'Crear Libro' }}
    </button>
</form>